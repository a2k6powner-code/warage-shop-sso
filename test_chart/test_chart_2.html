<!DOCTYPE html>
<html>
<head>
    <title>物品行情终端 (HUD模式)</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        /* HUD 风格基础样式 */
        body { 
            background: #000000; 
            color: #00ffcc; 
            font-family: 'Consolas', 'Courier New', monospace; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }
        
        /* 控制栏：像终端输入框 */
        .controls { 
            margin-bottom: 20px; 
            background: rgba(0, 255, 204, 0.05); 
            padding: 10px 20px; 
            border: 1px solid #00ffcc; 
            border-radius: 2px; 
            display: flex; 
            gap: 15px; 
            align-items: center; 
            box-shadow: 0 0 10px rgba(0, 255, 204, 0.2);
        }
        
        label { font-weight: bold; letter-spacing: 1px; }
        
        input { 
            background: #000; 
            border: none; 
            border-bottom: 1px solid #00ffcc; 
            color: #fff; 
            padding: 5px; 
            outline: none; 
            font-family: inherit;
            width: 150px;
        }
        
        button { 
            background: #00ffcc; 
            color: #000; 
            border: none; 
            padding: 5px 15px; 
            cursor: pointer; 
            font-weight: bold; 
            text-transform: uppercase;
            transition: 0.2s;
        }
        
        button:hover { 
            background: #fff; 
            box-shadow: 0 0 15px #00ffcc;
        }

        /* 图表容器 */
        #chart { 
            width: 900px; 
            height: 500px; 
            border: 1px solid #333; 
            position: relative;
        }
        
        /* 状态文字 */
        #status { font-size: 12px; opacity: 0.8; }
    </style>
</head>
<body>

    <div class="controls">
        <label>TARGET_ID:</label>
        <input type="text" id="itemId" value="diamond_sword">
        <button onclick="loadChart()">INITIALIZE</button>
        <span id="status">SYSTEM READY</span>
    </div>

    <div id="chart"></div>

    <script>
        const chartContainer = document.getElementById('chart');
        
        // --- 1. 创建图表：纯黑赛博风格 ---
        const chart = LightweightCharts.createChart(chartContainer, {
            layout: {
                background: { type: 'solid', color: '#000000' }, // 纯黑背景
                textColor: '#00ffcc', // 默认文字青色
            },
            grid: {
                vertLines: { visible: false }, // 隐藏所有网格
                horzLines: { visible: false },
            },
            // 价格轴样式
            rightPriceScale: {
                borderColor: 'rgba(0, 255, 204, 0.3)',
                scaleMargins: {
                    top: 0.1,    // K线最高不顶格
                    bottom: 0.2, // 留出底部 20% 给成交量
                },
            },
            // 时间轴样式
            timeScale: {
                borderColor: 'rgba(0, 255, 204, 0.3)',
                timeVisible: true,
                secondsVisible: false,
            },
            crosshair: {
                mode: 0, // 磁吸模式
                vertLine: { 
                    color: 'rgba(0, 255, 204, 0.5)',
                    labelBackgroundColor: '#00ffcc',
                },
                horzLine: { 
                    color: 'rgba(0, 255, 204, 0.5)',
                    labelBackgroundColor: '#00ffcc',
                },
            },
        });

        // --- 2. 成交量系列 (Volume) - 放在底层 ---
        const volumeSeries = chart.addHistogramSeries({
            priceFormat: { type: 'volume' },
            priceScaleId: '', // 独立于价格轴，固定在底部
            scaleMargins: {
                top: 0.8, // 柱子最高只占图表底部 20%
                bottom: 0,
            },
        });

        // --- 3. K线系列 (Candlestick) - 放在上层 ---
        const candlestickSeries = chart.addCandlestickSeries({
            upColor: '#000000',           // 涨：空心或黑色填充
            borderUpColor: '#00ffcc',     // 涨：青色边框
            wickUpColor: '#00ffcc',       // 涨：青色影线
            
            downColor: '#ff0055',         // 跌：实心粉红
            borderDownColor: '#ff0055',   // 跌：粉红边框
            wickDownColor: '#ff0055',     // 跌：粉红影线
        });

        // --- 4. 数据加载逻辑 ---
        async function loadChart() {
            const itemId = document.getElementById('itemId').value;
            const statusEl = document.getElementById('status');
            
            statusEl.innerText = `FETCHING DATA FOR [${itemId}]...`;
            statusEl.style.color = "#00ffcc";

            try {
                // 请求后端
                const res = await fetch(`http://localhost:3000/api/market/kline?itemId=${itemId}&resolution=60`);
                const json = await res.json();

                if (json.success) {
                    const klineData = json.data;
                    
                    if (klineData.length === 0) {
                        statusEl.innerText = "NO DATA FOUND";
                        statusEl.style.color = "orange";
                        candlestickSeries.setData([]);
                        volumeSeries.setData([]);
                        return;
                    }

                    // A. 填充 K 线数据
                    candlestickSeries.setData(klineData);

                    // B. 转换并填充成交量数据
                    const volumeData = klineData.map(item => ({
                        time: item.time,
                        value: item.volume,
                        // 涨的时候柱子青色(半透明)，跌的时候粉色(半透明)
                        color: item.close >= item.open ? 'rgba(0, 255, 204, 0.3)' : 'rgba(255, 0, 85, 0.3)'
                    }));
                    
                    volumeSeries.setData(volumeData);
                    
                    // 自动缩放
                    chart.timeScale().fitContent();

                    // 更新状态栏显示最新价格
                    const lastClose = klineData[klineData.length - 1].close;
                    statusEl.innerText = `DATA SYNCED. LAST PRICE: ${lastClose} ISK`;
                    
                } else {
                    statusEl.innerText = "ERROR: " + json.error;
                    statusEl.style.color = "red";
                }
            } catch (err) {
                console.error(err);
                statusEl.innerText = "CONNECTION LOST";
                statusEl.style.color = "red";
            }
        }
        
        // 初始化加载
        loadChart();
    </script>
</body>
</html>